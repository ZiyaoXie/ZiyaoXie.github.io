<!doctype html><html lang=zh-CN><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://imx.ink/images/favicon.png><title>ChaosBlade 简述及内部实现逻辑 | 提笔忘字</title>
<meta name=title content="ChaosBlade 简述及内部实现逻辑"><meta name=description content='ChaosBlade 是一款混沌工程工具，目前支持的演练场景有操作系统类的 CPU、磁盘、进程、网络，Java 应用类的 Dubbo、MySQL、Servlet 和自定义类方法延迟或抛异常等以及杀容器、杀 Pod。
Chaosblade 可直接编译运行，支持 cli 命令，具体可执行 blade create -h 查看：
Create a chaos engineering experiment Usage: blade create [command] Aliases: create, c Examples: create dubbo delay --time 3000 --offset 100 --service com.example.Service --consumer Available Commands: cplus c++ experiment cpu Cpu experiment disk Disk experiment docker Execute a docker experiment druid Druid experiment dubbo dubbo experiment http http experiment jvm method k8s Kubernetes experiment mysql mysql experiment network Network experiment process Process experiment rocketmq Rocketmq experiment,can make message send or pull delay and exception script Script chaos experiment servlet java servlet experiment Flags: -h, --help help for create Global Flags: -d, --debug Set client to DEBUG mode Use "blade create [command] --help" for more information about a command.'><meta name=keywords content="chaosblade,混沌工程,"><meta property="og:title" content="ChaosBlade 简述及内部实现逻辑"><meta property="og:description" content='ChaosBlade 是一款混沌工程工具，目前支持的演练场景有操作系统类的 CPU、磁盘、进程、网络，Java 应用类的 Dubbo、MySQL、Servlet 和自定义类方法延迟或抛异常等以及杀容器、杀 Pod。
Chaosblade 可直接编译运行，支持 cli 命令，具体可执行 blade create -h 查看：
Create a chaos engineering experiment Usage: blade create [command] Aliases: create, c Examples: create dubbo delay --time 3000 --offset 100 --service com.example.Service --consumer Available Commands: cplus c++ experiment cpu Cpu experiment disk Disk experiment docker Execute a docker experiment druid Druid experiment dubbo dubbo experiment http http experiment jvm method k8s Kubernetes experiment mysql mysql experiment network Network experiment process Process experiment rocketmq Rocketmq experiment,can make message send or pull delay and exception script Script chaos experiment servlet java servlet experiment Flags: -h, --help help for create Global Flags: -d, --debug Set client to DEBUG mode Use "blade create [command] --help" for more information about a command.'><meta property="og:type" content="article"><meta property="og:url" content="https://imx.ink/tech/2023/07/14/introduction-and-implementation-of-chaosblade/"><meta property="og:image" content="https://imx.ink/images/share.png"><meta property="article:section" content="tech"><meta property="article:published_time" content="2023-07-14T19:52:00+08:00"><meta property="article:modified_time" content="2023-07-14T19:52:00+08:00"><meta property="og:site_name" content="提笔忘字"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://imx.ink/images/share.png"><meta name=twitter:title content="ChaosBlade 简述及内部实现逻辑"><meta name=twitter:description content='ChaosBlade 是一款混沌工程工具，目前支持的演练场景有操作系统类的 CPU、磁盘、进程、网络，Java 应用类的 Dubbo、MySQL、Servlet 和自定义类方法延迟或抛异常等以及杀容器、杀 Pod。
Chaosblade 可直接编译运行，支持 cli 命令，具体可执行 blade create -h 查看：
Create a chaos engineering experiment Usage: blade create [command] Aliases: create, c Examples: create dubbo delay --time 3000 --offset 100 --service com.example.Service --consumer Available Commands: cplus c++ experiment cpu Cpu experiment disk Disk experiment docker Execute a docker experiment druid Druid experiment dubbo dubbo experiment http http experiment jvm method k8s Kubernetes experiment mysql mysql experiment network Network experiment process Process experiment rocketmq Rocketmq experiment,can make message send or pull delay and exception script Script chaos experiment servlet java servlet experiment Flags: -h, --help help for create Global Flags: -d, --debug Set client to DEBUG mode Use "blade create [command] --help" for more information about a command.'><meta itemprop=name content="ChaosBlade 简述及内部实现逻辑"><meta itemprop=description content='ChaosBlade 是一款混沌工程工具，目前支持的演练场景有操作系统类的 CPU、磁盘、进程、网络，Java 应用类的 Dubbo、MySQL、Servlet 和自定义类方法延迟或抛异常等以及杀容器、杀 Pod。
Chaosblade 可直接编译运行，支持 cli 命令，具体可执行 blade create -h 查看：
Create a chaos engineering experiment Usage: blade create [command] Aliases: create, c Examples: create dubbo delay --time 3000 --offset 100 --service com.example.Service --consumer Available Commands: cplus c++ experiment cpu Cpu experiment disk Disk experiment docker Execute a docker experiment druid Druid experiment dubbo dubbo experiment http http experiment jvm method k8s Kubernetes experiment mysql mysql experiment network Network experiment process Process experiment rocketmq Rocketmq experiment,can make message send or pull delay and exception script Script chaos experiment servlet java servlet experiment Flags: -h, --help help for create Global Flags: -d, --debug Set client to DEBUG mode Use "blade create [command] --help" for more information about a command.'><meta itemprop=datePublished content="2023-07-14T19:52:00+08:00"><meta itemprop=dateModified content="2023-07-14T19:52:00+08:00"><meta itemprop=wordCount content="1204"><meta itemprop=image content="https://imx.ink/images/share.png"><meta itemprop=keywords content="chaosblade,混沌工程,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px;overflow-x:auto}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=/ class=title><h2>提笔忘字</h2></a><nav><a href=/>主页</a>
<a href=/tech>技术文章</a>
<a href=/project>项目实践</a>
<a href=/xueqiu>滚雪球</a>
<a href=/about>关于</a></nav></header><main><content><p>ChaosBlade 是一款混沌工程工具，目前支持的演练场景有操作系统类的 CPU、磁盘、进程、网络，Java 应用类的 Dubbo、MySQL、Servlet 和自定义类方法延迟或抛异常等以及杀容器、杀 Pod。</p><p>Chaosblade 可直接编译运行，支持 cli 命令，具体可执行 <code>blade create -h</code> 查看：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Create a chaos engineering experiment
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Usage:
</span></span><span style=display:flex><span>  blade create <span style=color:#f92672>[</span>command<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Aliases:
</span></span><span style=display:flex><span>  create, c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Examples:
</span></span><span style=display:flex><span>create dubbo delay --time <span style=color:#ae81ff>3000</span> --offset <span style=color:#ae81ff>100</span> --service com.example.Service --consumer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Available Commands:
</span></span><span style=display:flex><span>  cplus       c++ experiment
</span></span><span style=display:flex><span>  cpu         Cpu experiment
</span></span><span style=display:flex><span>  disk        Disk experiment
</span></span><span style=display:flex><span>  docker      Execute a docker experiment
</span></span><span style=display:flex><span>  druid       Druid experiment
</span></span><span style=display:flex><span>  dubbo       dubbo experiment
</span></span><span style=display:flex><span>  http        http experiment
</span></span><span style=display:flex><span>  jvm         method
</span></span><span style=display:flex><span>  k8s         Kubernetes experiment
</span></span><span style=display:flex><span>  mysql       mysql experiment
</span></span><span style=display:flex><span>  network     Network experiment
</span></span><span style=display:flex><span>  process     Process experiment
</span></span><span style=display:flex><span>  rocketmq    Rocketmq experiment,can make message send or pull delay and exception
</span></span><span style=display:flex><span>  script      Script chaos experiment
</span></span><span style=display:flex><span>  servlet     java servlet experiment
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Flags:
</span></span><span style=display:flex><span>  -h, --help   help <span style=color:#66d9ef>for</span> create
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Global Flags:
</span></span><span style=display:flex><span>  -d, --debug   Set client to DEBUG mode
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Use <span style=color:#e6db74>&#34;blade create [command] --help&#34;</span> <span style=color:#66d9ef>for</span> more information about a command.
</span></span></code></pre></div><p>github地址: <a href=https://github.com/chaosblade-io/chaosblade>https://github.com/chaosblade-io/chaosblade</a></p><h2 id=组件架构>组件架构</h2><p><img src=https://f005.backblazeb2.com/file/wml5yw8gwgll/20230714/chaosblade_architecture.png alt=图片></p><ul><li>Cli 包含 create、destroy、status、prepare、revoke、version 6 个命令；</li><li>相关混沌实验数据使用 SQLite 存储在本地（chaosblade 目录下）；</li><li>Create 和 destroy 命令调用相关的混沌实验执行器创建或者销毁混沌实验；</li><li>Prepare 和 revoke 命令调用混沌实验准备执行器准备或者恢复实验环境，比如挂载 jvm-sandbox；</li><li>混沌实验和混沌实验环境准备记录都可以通过 status 命令查询；</li></ul><h2 id=chaosblade使用指南>ChaosBlade使用指南</h2><p>获取 ChaosBlade 最新的 release 包，目前支持的平台是 linux/amd64 和 darwin/64，下载对应平台的包。</p><p>github地址: <a href=https://github.com/chaosblade-io/chaosblade/releases/>https://github.com/chaosblade-io/chaosblade/releases/</a></p><p>下载完成后解压即可，无需编译。解压后的目录如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── bin
</span></span><span style=display:flex><span>│   ├── chaos_burncpu
</span></span><span style=display:flex><span>│   ├── chaos_burnio
</span></span><span style=display:flex><span>│   ├── chaos_changedns
</span></span><span style=display:flex><span>│   ├── chaos_delaynetwork
</span></span><span style=display:flex><span>│   ├── chaos_dropnetwork
</span></span><span style=display:flex><span>│   ├── chaos_filldisk
</span></span><span style=display:flex><span>│   ├── chaos_killprocess
</span></span><span style=display:flex><span>│   ├── chaos_lossnetwork
</span></span><span style=display:flex><span>│   ├── chaos_stopprocess
</span></span><span style=display:flex><span>│   ├── cplus-chaosblade.spec.yaml
</span></span><span style=display:flex><span>│   ├── jvm.spec.yaml
</span></span><span style=display:flex><span>│   └── tools.jar
</span></span><span style=display:flex><span>├── blade
</span></span><span style=display:flex><span>└── lib
</span></span><span style=display:flex><span>    ├── cplus
</span></span><span style=display:flex><span>    │   ├── chaosblade-exec-cplus.jar
</span></span><span style=display:flex><span>    │   └── script
</span></span><span style=display:flex><span>    │       ├── shell_break_and_return_attach.sh
</span></span><span style=display:flex><span>    │       ├── shell_break_and_return.sh
</span></span><span style=display:flex><span>    │       ├── shell_check_process_duplicate.sh
</span></span><span style=display:flex><span>    │       ├── shell_check_process_id.sh
</span></span><span style=display:flex><span>    │       ├── shell_initialization.sh
</span></span><span style=display:flex><span>    │       ├── shell_modify_variable_attch.sh
</span></span><span style=display:flex><span>    │       ├── shell_modify_variable.sh
</span></span><span style=display:flex><span>    │       ├── shell_remove_process.sh
</span></span><span style=display:flex><span>    │       ├── shell_response_delay_attach.sh
</span></span><span style=display:flex><span>    │       └── shell_response_delay.sh
</span></span><span style=display:flex><span>    └── sandbox
</span></span><span style=display:flex><span>        ├── bin
</span></span><span style=display:flex><span>        │   └── sandbox.sh
</span></span><span style=display:flex><span>        ├── cfg
</span></span><span style=display:flex><span>        │   ├── sandbox-logback.xml
</span></span><span style=display:flex><span>        │   ├── sandbox.properties
</span></span><span style=display:flex><span>        │   └── version
</span></span><span style=display:flex><span>        ├── example
</span></span><span style=display:flex><span>        │   └── sandbox-debug-module.jar
</span></span><span style=display:flex><span>        ├── install-local.sh
</span></span><span style=display:flex><span>        ├── lib
</span></span><span style=display:flex><span>        │   ├── sandbox-agent.jar
</span></span><span style=display:flex><span>        │   ├── sandbox-core.jar
</span></span><span style=display:flex><span>        │   └── sandbox-spy.jar
</span></span><span style=display:flex><span>        ├── module
</span></span><span style=display:flex><span>        │   ├── chaosblade-java-agent-0.2.0.jar
</span></span><span style=display:flex><span>        │   └── sandbox-mgr-module.jar
</span></span><span style=display:flex><span>        └── provider
</span></span><span style=display:flex><span>            └── sandbox-mgr-provider.jar
</span></span></code></pre></div><p>其中 blade 是可执行文件，即 chaosblade 工具的 cli，混沌实验执行的工具。执行 <code>./blade help</code> 可以查看支持命令有哪些：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ./blade help
</span></span><span style=display:flex><span>An easy to use and powerful chaos engineering experiment toolkit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Usage:
</span></span><span style=display:flex><span>  blade <span style=color:#f92672>[</span>command<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Available Commands:
</span></span><span style=display:flex><span>  create      Create a chaos engineering experiment
</span></span><span style=display:flex><span>  destroy     Destroy a chaos experiment
</span></span><span style=display:flex><span>  help        Help about any command
</span></span><span style=display:flex><span>  prepare     Prepare to experiment
</span></span><span style=display:flex><span>  query       Query the parameter values required <span style=color:#66d9ef>for</span> chaos experiments
</span></span><span style=display:flex><span>  revoke      Undo chaos engineering experiment preparation
</span></span><span style=display:flex><span>  status      Query preparation stage or experiment status
</span></span><span style=display:flex><span>  version     Print version info
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Flags:
</span></span><span style=display:flex><span>  -d, --debug   Set client to DEBUG mode
</span></span><span style=display:flex><span>  -h, --help    help <span style=color:#66d9ef>for</span> blade
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Use <span style=color:#e6db74>&#34;blade [command] --help&#34;</span> <span style=color:#66d9ef>for</span> more information about a command.
</span></span></code></pre></div><p>blade 命令列表如下：</p><ul><li>prepare：简写 p，混沌实验前的准备，比如演练 Java 应用，则需要挂载 java agent。要演练应用名是 business 的应用，则在目标主机上执行 blade p jvm &ndash;process business。如果挂载成功，返回挂载的 uid，用于状态查询或者撤销挂载使用；</li><li>revoke：简写 r，撤销之前混沌实验准备，比如卸载 java agent。命令是 blade revoke UID；</li><li>create: 简写是 c，创建一个混沌演练实验，指执行故障注入。命令是 blade create [TARGET] [ACTION] [FLAGS]，如果注入成功，则返回实验的 uid，用于状态查询和销毁此实验使用；</li><li>destroy：简写是 d，销毁之前的混沌实验，比如销毁上面提到的 Dubbo 延迟实验，命令是 blade destroy UID；</li><li>status：简写 s，查询准备阶段或者实验的状态，命令是 blade status UID 或者 blade status &ndash;type create；</li></ul><p>以上命令帮助均可使用 <code>blade help [COMMAND]</code>。</p><h3 id=应用示例>应用示例</h3><p>以CPU使用率100%的故障为例，即blade create cpu fullload命令。blade create cpu的用法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ./blade create cpu -h
</span></span><span style=display:flex><span>Cpu experiment, <span style=color:#66d9ef>for</span> example full load
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Usage:
</span></span><span style=display:flex><span>  blade create cpu <span style=color:#f92672>[</span>flags<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  blade create cpu <span style=color:#f92672>[</span>command<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Examples:
</span></span><span style=display:flex><span>cpu fullload
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Available Commands:
</span></span><span style=display:flex><span>  fullload    cpu fullload
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Flags:
</span></span><span style=display:flex><span>      --cpu-count string   Cpu count
</span></span><span style=display:flex><span>      --cpu-list string    CPUs in which to allow burning <span style=color:#f92672>(</span>0-3 or 1,3<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  -h, --help               help <span style=color:#66d9ef>for</span> cpu
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Global Flags:
</span></span><span style=display:flex><span>  -d, --debug   Set client to DEBUG mode
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Use <span style=color:#e6db74>&#34;blade create cpu [command] --help&#34;</span> <span style=color:#66d9ef>for</span> more information about a command.
</span></span></code></pre></div><p>执行实验：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ./blade create cpu fullload
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;code&#34;</span>:200,<span style=color:#e6db74>&#34;success&#34;</span>:true,<span style=color:#e6db74>&#34;result&#34;</span>:<span style=color:#e6db74>&#34;d9e3879cb68416a2&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>注意上面的<code>result: d9e3879cb68416a2</code>中的<code>d9e3879cb68416a2</code>，这个在停止实验的时候会用到（<code>./blade destroy UID</code>）。</p><p>采用<code>iostat -c 1 1000</code>命令查看CPU使用率（%idle）:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>avg-cpu:  %user   %nice %system %iowait  %steal   %idle
</span></span><span style=display:flex><span>          98.75    0.00    1.25    0.00    0.00    0.00
</span></span></code></pre></div><p>查看CPU的使用率还可以使用sar命令、top命令等。</p><p>此时命令已经生效。下一步停止实验，执行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ./blade destroy d9e3879cb68416a2
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;code&#34;</span>:200,<span style=color:#e6db74>&#34;success&#34;</span>:true,<span style=color:#e6db74>&#34;result&#34;</span>:<span style=color:#e6db74>&#34;command: cpu fullload --debug false --help false&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>再观察CPU的情况，负载已经回到正常状态：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>avg-cpu:  %user   %nice %system %iowait  %steal   %idle
</span></span><span style=display:flex><span>           0.25    0.00    0.50    2.00    0.00   97.25
</span></span></code></pre></div><h2 id=chaosblade-内部实现逻辑简述>ChaosBlade 内部实现逻辑简述</h2><p>以cpu满载（使用率达到100%）举例。在<code>./blade create cpu</code>命令中，我们可以通过<code>--cpu-count</code>用来指定cpu满载的内核个数；还可以通过<code>--cpu-list</code>来指定需要的满载的cpu内核编号，可以使用“1,3”这种形式来分别指定编号为1和3的cpu内核满载，也可以“0-3”这种形式来指定编号为0至3（0，1，2，3）的cpu内核满载。</p><h3 id=逻辑剖析>逻辑剖析</h3><p>如果不是直接使用下载的release版本，而是使用源码。那么在使用 ChaosBlade 前需要将源码（project）编译，其中就会把project下的 <code>exec/os/bin/</code> 目录下的文件编译成chaos_xxx类型的可执行文件。</p><p>exec/os/bin/目录内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cd exec/os/bin/
</span></span><span style=display:flex><span>$ tree
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── burncpu
</span></span><span style=display:flex><span>│   ├── burncpu.go
</span></span><span style=display:flex><span>│   └── burncpu_test.go
</span></span><span style=display:flex><span>├── burnio
</span></span><span style=display:flex><span>│   ├── burnio.go
</span></span><span style=display:flex><span>│   └── burnio_test.go
</span></span><span style=display:flex><span>├── changedns
</span></span><span style=display:flex><span>│   ├── changedns.go
</span></span><span style=display:flex><span>│   └── changedns_test.go
</span></span><span style=display:flex><span>├── common.go
</span></span><span style=display:flex><span>├── delaynetwork
</span></span><span style=display:flex><span>│   ├── delaynetwork.go
</span></span><span style=display:flex><span>│   └── delaynetwork_test.go
</span></span><span style=display:flex><span>├── dropnetwork
</span></span><span style=display:flex><span>│   ├── dropnetwork.go
</span></span><span style=display:flex><span>│   └── dropnetwork_test.go
</span></span><span style=display:flex><span>├── filldisk
</span></span><span style=display:flex><span>│   ├── filldisk.go
</span></span><span style=display:flex><span>│   └── filldisk_test.go
</span></span><span style=display:flex><span>├── killprocess
</span></span><span style=display:flex><span>│   ├── killprocess.go
</span></span><span style=display:flex><span>│   └── killProcess_test.go
</span></span><span style=display:flex><span>├── lossnetwork
</span></span><span style=display:flex><span>│   ├── lossnetwork.go
</span></span><span style=display:flex><span>│   └── lossnetwork_test.go
</span></span><span style=display:flex><span>└── stopprocess
</span></span><span style=display:flex><span>    └── stopprocess.go
</span></span></code></pre></div><p>在使用<code>./blade create cpu fulloload</code>命令的时候其实在内部就转化为了直接调用 <code>bin/chaos_burncpu</code>。而<code>blade</code>这个可执行文件只是使用了Cobra来实现的CLI入口。</p><p>Cobra既是用于创建强大的现代CLI应用程序的库，也是用于生成应用程序和命令文件的程序。许多使用最广泛的Go项目都是使用Cobra构建的，其中包括：kubernetes、docker、openshift、Hugo等。</p><p>也就是说，实际上我们不需要使用<code>./blade create cpu fulloload</code>命令来使得cpu满载，使用bin/目录下的chaos_burncpu即可。</p><h3 id=burncpu实现简述>burncpu实现简述</h3><p>chaos_burncpu中实现CPU满载负荷的逻辑其实相当简单，通过程序让CPU一直运作即可。代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>burnCpu</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>GOMAXPROCS</span>(<span style=color:#a6e22e>cpuCount</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>cpuCount</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>2147483647</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Gosched</span>() <span style=color:#75715e>//让出CPU时间片
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            }
</span></span><span style=display:flex><span>        }()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> {} <span style=color:#75715e>// wait forever
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>关闭CPU满载负荷的过程也比较简单粗暴，总共分为两步：</p><ol><li>使用 <code>ps -ef | grep …</code> 命令找出chaos_burncpu的pid。</li><li>使用 <code>kill -9 pid</code> 命令干掉它。</li></ol><h3 id=指定内核满载>指定内核满载</h3><p>我们在上面就了解到通过<code>--cpu-count</code>可以指定CPU满载的内核个数，通过<code>--cpu-list</code>可以指定内核满载。</p><p><code>--cpu-count</code>的功能很好实现，在上面的<code>func burnCpu()</code>函数中的cpuCount就是<code>--cpu-count</code>所指定的值。</p><p><code>--cpu-list</code>的功能比较复杂，总共分为3步：</p><ul><li>第一步：执行 <code>nohup bin/chaos_burncpu --nohup --cpu-count 1 --cpu-processor [cpu内核编号] > /dev/null 2>&amp;1 &</code>。假设我们要指定编号为1的内核满载，那么对应的命令即为：<code>nohup bin/chaos_burncpu --nohup --cpu-count 1 --cpu-processor 1 > /dev/null 2>&amp;1 &</code>。其实这个只是个烟雾弹，实际上还是调用原本的 <code>bin/chaos_burncpu --start --cpu-count 1</code> 而已，只不过这里多了一个 cpu-processor 的信息，这个在下面有用。</li><li>第二步：执行 <code>ps -ef | grep …</code> 命令找出对应的pid。</li><li>第三步：将进程pid绑定到编号为 cpu-processor 的内核上。</li></ul><p>CPU affinity （亲和力/亲和性）是一种调度属性（scheduler property）, 它可以将一个进程"绑定" 到一个或一组CPU上。taskset命令用于获取或者设定CPU affinity。</p><h2 id=os级故障实现原理解析>OS级故障实现原理解析</h2><p>在上一章中我们了解了burncpu的故障实现原理，本章主要来描述一下下面列表中除burncpu之外的故障实现原理。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>├── bin
</span></span><span style=display:flex><span>│   ├── chaos_burncpu
</span></span><span style=display:flex><span>│   ├── chaos_burnio
</span></span><span style=display:flex><span>│   ├── chaos_changedns
</span></span><span style=display:flex><span>│   ├── chaos_delaynetwork
</span></span><span style=display:flex><span>│   ├── chaos_dropnetwork
</span></span><span style=display:flex><span>│   ├── chaos_filldisk
</span></span><span style=display:flex><span>│   ├── chaos_killprocess
</span></span><span style=display:flex><span>│   ├── chaos_lossnetwork
</span></span><span style=display:flex><span>│   ├── chaos_stopprocess
</span></span></code></pre></div><h3 id=1-chaos_burnio>1. chaos_burnio</h3><p>模拟I/O读写满负荷运作：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bin/chaos_burnio --file-system /dev/sda1 --size <span style=color:#ae81ff>1</span> --count <span style=color:#ae81ff>1024</span> --read<span style=color:#f92672>=</span>true --write<span style=color:#f92672>=</span>false --nohup<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>bin/chaos_burnio --file-system /dev/sda1 --size <span style=color:#ae81ff>1</span> --count <span style=color:#ae81ff>1024</span> --read<span style=color:#f92672>=</span>false --write<span style=color:#f92672>=</span>true --nohup<span style=color:#f92672>=</span>true
</span></span></code></pre></div><p>原理：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># read</span>
</span></span><span style=display:flex><span>dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/sda1 of<span style=color:#f92672>=</span>/dev/null bs<span style=color:#f92672>=</span>1M count<span style=color:#f92672>=</span><span style=color:#ae81ff>1024</span> iflag<span style=color:#f92672>=</span>dsync,direct,fullblock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># write</span>
</span></span><span style=display:flex><span>dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/zero of<span style=color:#f92672>=</span>/tmp/chaos_burnio.log.dat bs<span style=color:#f92672>=</span>1M count<span style=color:#f92672>=</span><span style=color:#ae81ff>1024</span> oflag<span style=color:#f92672>=</span>dsync
</span></span></code></pre></div><h3 id=2-chaos_filldisk>2. chaos_filldisk</h3><p>磁盘填充：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 其中size是指定填充磁盘的大小，单位为MB</span>
</span></span><span style=display:flex><span>./blade create disk fill --size <span style=color:#ae81ff>1000</span>
</span></span></code></pre></div><p>原理：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/zero of<span style=color:#f92672>=</span>/chaos_filldisk.log.dat bs<span style=color:#f92672>=</span>1M count<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span> iflag<span style=color:#f92672>=</span>fullblock
</span></span></code></pre></div><h3 id=3-chaos_changedns>3. chaos_changedns</h3><p>域名设定：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./blade create network dns --domain www.hidden.com --ip localhost
</span></span></code></pre></div><p>实际效果会在<code>/etc/hosts</code>中添加一行记录：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>localhost www.hidden.com #claosblade
</span></span></code></pre></div><p>反之，就是删除掉这一行。</p><h3 id=4-chaos_delaynetwork>4. chaos_delaynetwork</h3><p>网络延迟：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># time指定延迟时间，单位为ms, offset指定延迟波动大小</span>
</span></span><span style=display:flex><span>./blade create network delay --interface eth0 --time <span style=color:#ae81ff>300</span>
</span></span><span style=display:flex><span>./blade create network delay --interface eth0 --time <span style=color:#ae81ff>300</span> --offset <span style=color:#ae81ff>50</span>
</span></span></code></pre></div><p>原理：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>tc qdisc add dev eth0 root netem delay 300ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#该命令将 eth0 网卡的传输设置为延迟 300ms ± 50ms (250 ~ 350 ms 之间的任意值)发送</span>
</span></span><span style=display:flex><span>tc qdisc add dev eth0 root netem delay 300ms 50ms
</span></span></code></pre></div><p>恢复：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>tc qdisc del dev eth0 root netem
</span></span></code></pre></div><h3 id=5-chaos_dropnetwork>5. chaos_dropnetwork</h3><p>网络中断：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./blade create network drop --local-port <span style=color:#ae81ff>100</span> --remote-port <span style=color:#ae81ff>100</span>
</span></span></code></pre></div><p>原理：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>iptables -A INPUT -p tcp --dport <span style=color:#f92672>[</span>localPort<span style=color:#f92672>]</span> -j DROP
</span></span><span style=display:flex><span>iptables -A INPUT -p udp --dport <span style=color:#f92672>[</span>localPort<span style=color:#f92672>]</span> -J DROP
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>iptables -A OUTPUT -p tcp --dport <span style=color:#f92672>[</span>remotePort<span style=color:#f92672>]</span> -j DROP
</span></span><span style=display:flex><span>iptables -A OUTPUT -p udp --dport <span style=color:#f92672>[</span>remotePort<span style=color:#f92672>]</span> -j DROP
</span></span></code></pre></div><p>恢复：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>iptables -D INPUT -p tcp --dport <span style=color:#f92672>[</span>localPort<span style=color:#f92672>]</span> -j DROP
</span></span><span style=display:flex><span>iptables -D INPUT -p udp --dport <span style=color:#f92672>[</span>localPort<span style=color:#f92672>]</span> -J DROP
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>iptables -D OUTPUT -p tcp --dport <span style=color:#f92672>[</span>remotePort<span style=color:#f92672>]</span> -j DROP
</span></span><span style=display:flex><span>iptables -D OUTPUT -p udp --dport <span style=color:#f92672>[</span>remotePort<span style=color:#f92672>]</span> -j DROP
</span></span></code></pre></div><h3 id=6-chaos_lossnetwork>6. chaos_lossnetwork</h3><p>网络丢包：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./blade create network loss --interface eth0 --percent <span style=color:#ae81ff>10</span>
</span></span></code></pre></div><p>原理：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>tc qdisc add dev eth0 root netem loss 10%
</span></span></code></pre></div><h3 id=7-chaos_killprocess>7. chaos_killprocess</h3><p>杀死进程：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./blade create process kill --process chaos
</span></span></code></pre></div><p>原理：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kill -9
</span></span></code></pre></div><h3 id=8-chaos_stopprocess>8. chaos_stopprocess</h3><p>进程假死：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./blade create process stop --process chaos
</span></span></code></pre></div><p>原理：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kill -19
</span></span><span style=display:flex><span><span style=color:#75715e># 恢复：kill -18</span>
</span></span></code></pre></div><p>附录：各种信号及其用途。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kill -l
</span></span><span style=display:flex><span> 1<span style=color:#f92672>)</span> SIGHUP     2<span style=color:#f92672>)</span> SIGINT   3<span style=color:#f92672>)</span> SIGQUIT  4<span style=color:#f92672>)</span> SIGILL   5<span style=color:#f92672>)</span> SIGTRAP
</span></span><span style=display:flex><span> 6<span style=color:#f92672>)</span> SIGABRT     7<span style=color:#f92672>)</span> SIGBUS   8<span style=color:#f92672>)</span> SIGFPE   9<span style=color:#f92672>)</span> SIGKILL 10<span style=color:#f92672>)</span> SIGUSR1
</span></span><span style=display:flex><span>11<span style=color:#f92672>)</span> SIGSEGV    12<span style=color:#f92672>)</span> SIGUSR2 13<span style=color:#f92672>)</span> SIGPIPE 14<span style=color:#f92672>)</span> SIGALRM 15<span style=color:#f92672>)</span> SIGTERM
</span></span><span style=display:flex><span>16<span style=color:#f92672>)</span> SIGSTKFLT    17<span style=color:#f92672>)</span> SIGCHLD 18<span style=color:#f92672>)</span> SIGCONT 19<span style=color:#f92672>)</span> SIGSTOP 20<span style=color:#f92672>)</span> SIGTSTP
</span></span><span style=display:flex><span>21<span style=color:#f92672>)</span> SIGTTIN    22<span style=color:#f92672>)</span> SIGTTOU 23<span style=color:#f92672>)</span> SIGURG  24<span style=color:#f92672>)</span> SIGXCPU 25<span style=color:#f92672>)</span> SIGXFSZ
</span></span><span style=display:flex><span>26<span style=color:#f92672>)</span> SIGVTALRM    27<span style=color:#f92672>)</span> SIGPROF 28<span style=color:#f92672>)</span> SIGWINCH    29<span style=color:#f92672>)</span> SIGIO   30<span style=color:#f92672>)</span> SIGPWR
</span></span><span style=display:flex><span>31<span style=color:#f92672>)</span> SIGSYS    34<span style=color:#f92672>)</span> SIGRTMIN    35<span style=color:#f92672>)</span> SIGRTMIN+1  36<span style=color:#f92672>)</span> SIGRTMIN+2  37<span style=color:#f92672>)</span> SIGRTMIN+3
</span></span><span style=display:flex><span>38<span style=color:#f92672>)</span> SIGRTMIN+4    39<span style=color:#f92672>)</span> SIGRTMIN+5  40<span style=color:#f92672>)</span> SIGRTMIN+6  41<span style=color:#f92672>)</span> SIGRTMIN+7  42<span style=color:#f92672>)</span> SIGRTMIN+8
</span></span><span style=display:flex><span>43<span style=color:#f92672>)</span> SIGRTMIN+9    44<span style=color:#f92672>)</span> SIGRTMIN+10 45<span style=color:#f92672>)</span> SIGRTMIN+11 46<span style=color:#f92672>)</span> SIGRTMIN+12 47<span style=color:#f92672>)</span> SIGRTMIN+13
</span></span><span style=display:flex><span>48<span style=color:#f92672>)</span> SIGRTMIN+14    49<span style=color:#f92672>)</span> SIGRTMIN+15 50<span style=color:#f92672>)</span> SIGRTMAX-14 51<span style=color:#f92672>)</span> SIGRTMAX-13 52<span style=color:#f92672>)</span> SIGRTMAX-12
</span></span><span style=display:flex><span>53<span style=color:#f92672>)</span> SIGRTMAX-11    54<span style=color:#f92672>)</span> SIGRTMAX-10 55<span style=color:#f92672>)</span> SIGRTMAX-9  56<span style=color:#f92672>)</span> SIGRTMAX-8  57<span style=color:#f92672>)</span> SIGRTMAX-7
</span></span><span style=display:flex><span>58<span style=color:#f92672>)</span> SIGRTMAX-6    59<span style=color:#f92672>)</span> SIGRTMAX-5  60<span style=color:#f92672>)</span> SIGRTMAX-4  61<span style=color:#f92672>)</span> SIGRTMAX-3  62<span style=color:#f92672>)</span> SIGRTMAX-2
</span></span><span style=display:flex><span>63<span style=color:#f92672>)</span> SIGRTMAX-1    64<span style=color:#f92672>)</span> SIGRTMAX
</span></span></code></pre></div><h2 id=参考资料>参考资料</h2><ul><li><a href=https://github.com/chaosblade-io/chaosblade/blob/master/README_CN.md>https://github.com/chaosblade-io/chaosblade/blob/master/README_CN.md</a></li><li><a href=https://github.com/chaosblade-io/chaosblade/wiki/%E6%96%B0%E6%89%8B%E6%8C%87%E5%8D%97>https://github.com/chaosblade-io/chaosblade/wiki/%E6%96%B0%E6%89%8B%E6%8C%87%E5%8D%97</a></li><li><a href=https://github.com/chaosblade-io/chaosblade>https://github.com/chaosblade-io/chaosblade</a></li></ul></content><p><a href=https://imx.ink/chaosblade/>#Chaosblade</a>
<a href=https://imx.ink/%E6%B7%B7%E6%B2%8C%E5%B7%A5%E7%A8%8B/>#混沌工程</a></p></main><footer>Copyright © 2023, Xie Ziyao.</footer></body></html>